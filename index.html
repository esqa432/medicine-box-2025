<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Medicine Box - Dashboard</title>
    
    <!-- Import Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, update, remove, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAiBV0PaR282YuKk0my-s_i9n4kRJhFGDw",
            authDomain: "medicinbox-22916.firebaseapp.com",
            databaseURL: "https://medicinbox-22916-default-rtdb.firebaseio.com",
            projectId: "medicinbox-22916",
            storageBucket: "medicinbox-22916.firebasestorage.app",
            messagingSenderId: "395779143317",
            appId: "1:395779143317:web:7c1a0e9c4967bdadf90d9c"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseOnValue = onValue;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
        window.firebaseQuery = query;
        window.firebaseOrderByKey = orderByKey;
        window.firebaseLimitToLast = limitToLast;
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .nav { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .nav button { padding: 12px 24px; background: rgba(255,255,255,0.2); border: none; border-radius: 25px; color: white; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
        .nav button:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .nav button.active { background: rgba(255,255,255,0.4); transform: translateY(-2px); }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .box-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s ease; position: relative; }
        .box-card:hover { transform: translateY(-5px); }
        .box-card.alert { animation: blinkAlert 1s infinite; border: 3px solid #ff4444; }
        @keyframes blinkAlert {
            0%, 100% { background: #ff6b6b; color: white; }
            50% { background: #ff4444; color: white; }
        }
        .box-card.active-alert { 
            animation: blinkAlert 0.5s infinite; 
            border: 3px solid #ff4444;
            background: #ff6b6b;
            color: white;
        }
        .box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .box-number { font-size: 1.5em; font-weight: bold; }
        .status { padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }
        .status.alert { background: #ff4444; color: white; }
        .status.normal { background: #2ecc71; color: white; }
        .status.upcoming { background: #f39c12; color: white; }
        .patient-info, .medicine-info { margin-bottom: 10px; }
        .medicine-info { font-weight: bold; }
        .time-info { color: #666; font-size: 0.9em; margin-bottom: 5px; }
        .time-remaining { font-size: 1.1em; font-weight: bold; margin-top: 10px; padding: 8px; border-radius: 8px; text-align: center; }
        .time-remaining.soon { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .time-remaining.now { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .time-remaining.later { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        /* Alert Rectangle */
        .alert-rectangle {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            animation: pulse 2s infinite;
            border: 2px solid #ff0000;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .sensors { background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .sensor-readings { display: flex; gap: 20px; justify-content: center; }
        .sensor-item { text-align: center; padding: 15px; }
        .sensor-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .save-btn { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        .save-btn:hover { background: #2980b9; }
        .clear-btn { background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .clear-btn:hover { background: #c0392b; }
        .schedule-form { margin-bottom: 30px; padding: 20px; border: 2px solid #f0f0f0; border-radius: 10px; background: #fafafa; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .time-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .page { display: none; }
        #dashboard { display: block; }
        
        /* Alert Popup Styles */
        .alert-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ff4444;
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            min-width: 400px;
            animation: popIn 0.5s ease;
            border: 3px solid #ff0000;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .alert-title { font-size: 1.8em; margin-bottom: 15px; font-weight: bold; }
        .alert-patient { font-size: 1.3em; margin-bottom: 10px; }
        .alert-medicine { font-size: 1.1em; margin-bottom: 15px; }
        .alert-time { font-size: 0.9em; opacity: 0.9; margin-bottom: 20px; }
        .close-alert { background: rgba(255,255,255,0.3); border: none; color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 1em; }
        .close-alert:hover { background: rgba(255,255,255,0.4); }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        /* Reports Styling */
        .report-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 5px solid #2ecc71;
        }
        .report-item.missed {
            border-left-color: #e74c3c;
        }
        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* System Status */
        .system-status {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .status-item {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            background: #f8f9fa;
        }
        .status-item.online { background: #d4edda; color: #155724; }
        .status-item.offline { background: #f8d7da; color: #721c24; }
        
        /* Current Time Display */
        .current-time {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .time-display {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        .date-display {
            color: #666;
            font-size: 1.1em;
        }
        
        /* Website Alert */
        .website-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.5s ease;
            max-width: 300px;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Manual Trigger Button */
        .manual-trigger-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .manual-trigger-btn:hover {
            background: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíä Smart Medicine Box Dashboard</h1>
            <p>3-Box Medicine Monitoring System - Website Controlled Timing</p>
        </div>
        
        <div class="nav">
            <button onclick="showPage('dashboard')" class="active">üìä Dashboard</button>
            <button onclick="showPage('management')">‚è∞ Manage Schedule</button>
            <button onclick="showPage('reports')">üìà Reports & Analysis</button>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="current-time">
                <h2>üïí Current Oman Time (GMT+4)</h2>
                <div class="time-display" id="current-time">--:--:--</div>
                <div class="date-display" id="current-date">-- --- ----</div>
            </div>

            <div class="system-status">
                <h2>üîß System Status</h2>
                <div class="status-grid">
                    <div class="status-item" id="wifi-status">WiFi: Checking...</div>
                    <div class="status-item" id="firebase-status">Firebase: Checking...</div>
                    <div class="status-item" id="time-status">Control: Website</div>
                    <div class="status-item" id="uptime-status">Uptime: --</div>
                </div>
            </div>

            <div class="sensors">
                <h2>üå°Ô∏è Environmental Sensors</h2>
                <div class="sensor-readings">
                    <div class="sensor-item">
                        <div>Temperature</div>
                        <div class="sensor-value" id="temperature">--¬∞C</div>
                    </div>
                    <div class="sensor-item">
                        <div>Humidity</div>
                        <div class="sensor-value" id="humidity">--%</div>
                    </div>
                    <div class="sensor-item">
                        <div>Last Update</div>
                        <div class="sensor-value" id="last-update">--:--</div>
                    </div>
                </div>
            </div>

            <h2 style="color: white; margin-bottom: 15px;">üì¶ Medicine Boxes Status</h2>
            <div class="dashboard" id="boxes-container">
                <!-- Boxes will be populated by JavaScript -->
            </div>
        </div>

        <!-- Management Page -->
        <div id="management" class="page" style="display: none;">
            <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                <h2 style="margin-bottom: 20px; color: #333;">‚è∞ Medicine Schedule Management</h2>
                <p style="margin-bottom: 20px; color: #666;">Set medicine schedules for each box. The website will automatically trigger alerts at the specified Oman time (GMT+4).</p>
                <div id="schedule-forms">
                    <!-- Schedule forms will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reports" class="page" style="display: none;">
            <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                <h2 style="margin-bottom: 20px; color: #333;">üìà Patient Reports & Analysis</h2>
                <div id="reports-container">
                    <!-- Reports will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let boxesData = {};
        let scheduleData = {};
        let reportsData = {};
        let alertsData = {};
        let systemData = {};
        let currentAlert = null;
        let shownAlerts = new Set();
        let timeCheckInterval;
        let activeAlerts = {}; // Track which boxes have active alerts on website

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.firebaseDatabase) {
                    initDashboard();
                    startTimeUpdates();
                } else {
                    console.error('Firebase not loaded');
                }
            }, 1000);
        });

        function showPage(pageName) {
            // Update active button
            document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show selected page
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            document.getElementById(pageName).style.display = 'block';
            
            if (pageName === 'reports') loadReports();
            else if (pageName === 'management') loadScheduleForms();
        }

        function startTimeUpdates() {
            // Update time display every second
            setInterval(updateTimeDisplay, 1000);
            updateTimeDisplay();
        }

        function updateTimeDisplay() {
            const now = new Date();
            // Convert to Oman time (GMT+4)
            const omanTime = new Date(now.getTime() + (4 * 60 * 60 * 1000));
            
            const timeString = omanTime.toISOString().substr(11, 8);
            const dateString = omanTime.toISOString().substr(0, 10).split('-').reverse().join('/');
            
            document.getElementById('current-time').textContent = timeString;
            document.getElementById('current-date').textContent = dateString;
        }

        function initDashboard() {
            console.log('üî• Initializing Dashboard...');
            
            // Listen for boxes data
            const boxesRef = window.firebaseRef(window.firebaseDatabase, 'boxes');
            window.firebaseOnValue(boxesRef, (snapshot) => {
                boxesData = snapshot.val() || {};
                console.log('üì¶ Boxes data updated:', boxesData);
                updateBoxesDisplay();
            });

            // Listen for schedule data
            const scheduleRef = window.firebaseRef(window.firebaseDatabase, 'schedule');
            window.firebaseOnValue(scheduleRef, (snapshot) => {
                scheduleData = snapshot.val() || {};
                console.log('‚è∞ Schedule data updated:', scheduleData);
                updateBoxesDisplay();
            });

            // Listen for sensor data
            const sensorsRef = window.firebaseRef(window.firebaseDatabase, 'sensors');
            window.firebaseOnValue(sensorsRef, (snapshot) => {
                const sensors = snapshot.val() || {};
                console.log('üå°Ô∏è Sensor data updated:', sensors);
                updateSensorsDisplay(sensors);
            });

            // Listen for alerts
            const alertsRef = window.firebaseRef(window.firebaseDatabase, 'alerts');
            window.firebaseOnValue(alertsRef, (snapshot) => {
                const alerts = snapshot.val() || {};
                console.log('üö® Alerts data updated:', alerts);
                alertsData = alerts;
                checkForNewAlerts(alerts);
                updateBoxesDisplay();
            });

            // Listen for reports
            const reportsRef = window.firebaseRef(window.firebaseDatabase, 'reports');
            window.firebaseOnValue(reportsRef, (snapshot) => {
                reportsData = snapshot.val() || {};
                console.log('üìä Reports data updated');
            });

            // Listen for system status
            const systemRef = window.firebaseRef(window.firebaseDatabase, 'system');
            window.firebaseOnValue(systemRef, (snapshot) => {
                systemData = snapshot.val() || {};
                updateSystemStatus();
            });

            // Start checking medicine times every second
            startMedicineTimeChecker();
            
            // Update boxes display every second for real-time countdown
            setInterval(updateBoxesDisplay, 1000);
            
            loadScheduleForms();
            
            // Request notification permission
            if ('Notification' in window) {
                Notification.requestPermission();
            }
            
            console.log('‚úÖ Dashboard initialized successfully');
        }

        function startMedicineTimeChecker() {
            // Clear existing interval if any
            if (timeCheckInterval) {
                clearInterval(timeCheckInterval);
            }
            
            // Check medicine times every second
            timeCheckInterval = setInterval(checkAndTriggerMedicineTimes, 1000);
            console.log('‚è∞ Medicine time checker started');
        }

        function checkAndTriggerMedicineTimes() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentSecond = now.getSeconds();
            
            // Debug: Log time check occasionally
            if (currentSecond % 30 === 0) {
                console.log('‚è∞ Time check:', currentHour + ':' + currentMinute + ':' + currentSecond);
            }
            
            for (let i = 1; i <= 3; i++) {
                const boxKey = 'box' + i;
                const schedule = scheduleData[boxKey] || {};
                
                if (schedule.active && 
                    currentHour === schedule.hour && 
                    currentMinute === schedule.minute && 
                    currentSecond === schedule.second) {
                    
                    console.log('üö® MEDICINE TIME! Box ' + i + ' - ' + schedule.patient + ' - ' + schedule.medicine);
                    
                    // Set medicine_time flag to true in Firebase
                    triggerMedicineTime(i, schedule);
                }
            }
        }

        function triggerMedicineTime(boxNumber, schedule) {
            const scheduleRef = window.firebaseRef(window.firebaseDatabase, `schedule/box${boxNumber}/medicine_time`);
            
            window.firebaseSet(scheduleRef, true)
                .then(() => {
                    console.log('‚úÖ medicine_time set to TRUE for Box ' + boxNumber);
                    
                    // Activate website alert for this box
                    activeAlerts[boxNumber] = true;
                    
                    // Show visual feedback on website
                    showWebsiteAlert(schedule.patient, schedule.medicine, boxNumber);
                    
                    // Create alert record
                    createAlertRecord(schedule.patient, schedule.medicine, boxNumber);
                    
                    // Start blinking animation for this box card
                    startBoxBlinking(boxNumber);
                })
                .catch((error) => {
                    console.error('‚ùå Error setting medicine_time:', error);
                });
        }

        function startBoxBlinking(boxNumber) {
            // The blinking is handled by CSS animation on the box-card
            // We just need to add the active-alert class
            const boxElement = document.querySelector(`.box-card[data-box="${boxNumber}"]`);
            if (boxElement) {
                boxElement.classList.add('active-alert');
            }
            
            // Stop blinking after 5 seconds (to match ESP32 timeout)
            setTimeout(() => {
                activeAlerts[boxNumber] = false;
                const boxElement = document.querySelector(`.box-card[data-box="${boxNumber}"]`);
                if (boxElement) {
                    boxElement.classList.remove('active-alert');
                }
            }, 5000);
        }

        function createAlertRecord(patient, medicine, boxNumber) {
            const alertId = new Date().getTime();
            const alertRef = window.firebaseRef(window.firebaseDatabase, `alerts/${alertId}`);
            
            const alertData = {
                patient: patient,
                medicine: medicine,
                box: boxNumber,
                scheduled_time: getCurrentOmanTime(),
                alert_time: new Date().toISOString(),
                taken: false,
                notified: false,
                status: 'pending'
            };
            
            window.firebaseSet(alertRef, alertData)
                .then(() => {
                    console.log('‚úÖ Alert record created for Box ' + boxNumber);
                })
                .catch((error) => {
                    console.error('‚ùå Error creating alert record:', error);
                });
        }

        function showWebsiteAlert(patient, medicine, boxNumber) {
            // Remove existing website alerts
            const existingAlerts = document.querySelectorAll('.website-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create new alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'website-alert';
            alertDiv.innerHTML = `
                <strong>üö® MEDICINE TIME!</strong><br>
                <strong>Box ${boxNumber}:</strong> ${patient}<br>
                <strong>Medicine:</strong> ${medicine}<br>
                <small>üì¶ ESP32 Box LED is now blinking for 5 seconds</small>
                <br><br>
                <button onclick="this.parentElement.remove()" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                    ‚úÖ Dismiss
                </button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Remove alert after 10 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 10000);
            
            // Browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('üíä Medicine Time!', {
                    body: `Box ${boxNumber}: ${patient} - ${medicine}\nESP32 LED is blinking for 5 seconds`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üíä</text></svg>',
                    requireInteraction: true
                });
            }
        }

        function getCurrentOmanTime() {
            const now = new Date();
            const omanTime = new Date(now.getTime() + (4 * 60 * 60 * 1000));
            return omanTime.toISOString().substr(11, 8);
        }

        function updateSystemStatus() {
            const wifiStatus = document.getElementById('wifi-status');
            const firebaseStatus = document.getElementById('firebase-status');
            const uptimeStatus = document.getElementById('uptime-status');
            
            if (systemData.wifi_status) {
                wifiStatus.textContent = `WiFi: ${systemData.wifi_status}`;
                wifiStatus.className = `status-item ${systemData.wifi_status === 'connected' ? 'online' : 'offline'}`;
            }
            
            if (systemData.last_update) {
                firebaseStatus.textContent = `Firebase: Connected`;
                firebaseStatus.className = 'status-item online';
            }
            
            if (systemData.uptime) {
                const hours = Math.floor(systemData.uptime / 3600);
                const minutes = Math.floor((systemData.uptime % 3600) / 60);
                uptimeStatus.textContent = `Uptime: ${hours}h ${minutes}m`;
            }
        }

        function updateBoxesDisplay() {
            const container = document.getElementById('boxes-container');
            if (!container) return;
            
            container.innerHTML = '';

            for (let i = 1; i <= 3; i++) {
                const boxKey = 'box' + i;
                const box = boxesData[boxKey] || {};
                const schedule = scheduleData[boxKey] || {};
                const timeRemaining = calculateTimeRemaining(schedule);
                const isAlertActive = box.alert_active;
                const isWebsiteAlertActive = activeAlerts[i];
                
                const card = document.createElement('div');
                card.className = `box-card ${isAlertActive || isWebsiteAlertActive ? 'active-alert' : ''}`;
                card.setAttribute('data-box', i);
                
                const status = isAlertActive || isWebsiteAlertActive ? 'ALERT! üö®' : (schedule.active ? 'Scheduled' : 'Inactive');
                const statusClass = isAlertActive || isWebsiteAlertActive ? 'alert' : (schedule.active ? 'upcoming' : 'normal');
                
                const scheduledTime = schedule.active ? 
                    `${schedule.hour.toString().padStart(2, '0')}:${schedule.minute.toString().padStart(2, '0')}:${(schedule.second || 0).toString().padStart(2, '0')}` : 
                    'Not scheduled';
                
                card.innerHTML = `
                    <div class="box-header">
                        <div class="box-number">üì¶ Box ${i}</div>
                        <div class="status ${statusClass}">${status}</div>
                    </div>
                    <div class="patient-info">
                        <strong>üë§ Patient:</strong> ${schedule.patient || 'Not assigned'}
                    </div>
                    <div class="medicine-info">
                        <strong>üíä Medicine:</strong> ${schedule.medicine || 'Not assigned'}
                    </div>
                    <div class="time-info">
                        <strong>‚è∞ Scheduled Time:</strong> ${scheduledTime}
                    </div>
                    ${schedule.active ? `
                        <div class="time-remaining ${getTimeRemainingClass(timeRemaining)}">
                            ${formatTimeRemaining(timeRemaining)}
                        </div>
                    ` : ''}
                    ${isAlertActive || isWebsiteAlertActive ? `
                        <div class="alert-rectangle">
                            üö® ALERT ACTIVE!<br>
                            ${schedule.patient} needs to take ${schedule.medicine}<br>
                            <small>LED blinking on physical box - Press button within 5 seconds</small>
                        </div>
                    ` : ''}
                    ${box.last_taken_time ? `
                        <div class="time-info">
                            <strong>‚úÖ Last Taken:</strong> ${formatFirebaseTime(box.last_taken_time)}
                        </div>
                    ` : ''}
                    <button class="manual-trigger-btn" onclick="manualTrigger(${i})">
                        üîî Test Trigger
                    </button>
                `;
                container.appendChild(card);
            }
        }

        function calculateTimeRemaining(schedule) {
            if (!schedule || !schedule.active) return null;
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentSecond = now.getSeconds();
            
            // Calculate total seconds until scheduled time
            let hoursDiff = schedule.hour - currentHour;
            let minutesDiff = schedule.minute - currentMinute;
            let secondsDiff = (schedule.second || 0) - currentSecond;
            
            // If time has passed today, calculate for tomorrow
            if (hoursDiff < 0 || (hoursDiff === 0 && minutesDiff < 0) || (hoursDiff === 0 && minutesDiff === 0 && secondsDiff < 0)) {
                hoursDiff += 24;
            }
            
            // Handle negative minutes/seconds by borrowing from hours/minutes
            if (secondsDiff < 0) {
                secondsDiff += 60;
                minutesDiff -= 1;
            }
            if (minutesDiff < 0) {
                minutesDiff += 60;
                hoursDiff -= 1;
            }
            
            // Convert to total milliseconds
            const totalSeconds = hoursDiff * 3600 + minutesDiff * 60 + secondsDiff;
            const totalMs = totalSeconds * 1000;
            
            return {
                hours: hoursDiff,
                minutes: minutesDiff,
                seconds: secondsDiff,
                totalMs: totalMs
            };
        }

        function formatTimeRemaining(timeRemaining) {
            if (!timeRemaining) return "No active schedule";
            if (timeRemaining.totalMs <= 0) return "üü¢ TIME TO TAKE MEDICINE!";
            if (timeRemaining.hours > 0) return `‚è≥ In ${timeRemaining.hours}h ${timeRemaining.minutes}m ${timeRemaining.seconds}s`;
            if (timeRemaining.minutes > 5) return `‚è≥ In ${timeRemaining.minutes}m ${timeRemaining.seconds}s`;
            return `üî¥ In ${timeRemaining.minutes}m ${timeRemaining.seconds}s`;
        }

        function getTimeRemainingClass(timeRemaining) {
            if (!timeRemaining) return "later";
            if (timeRemaining.totalMs <= 0) return "now";
            if (timeRemaining.minutes <= 5) return "soon";
            return "later";
        }

        function formatFirebaseTime(timestamp) {
            if (!timestamp) return 'Never';
            try {
                if (typeof timestamp === 'string' && timestamp.includes(':')) {
                    return timestamp;
                }
                return new Date(parseInt(timestamp)).toLocaleTimeString();
            } catch (e) {
                return timestamp;
            }
        }

        function updateSensorsDisplay(sensors) {
            if (sensors.temperature) {
                document.getElementById('temperature').textContent = sensors.temperature.toFixed(1) + '¬∞C';
            }
            if (sensors.humidity) {
                document.getElementById('humidity').textContent = sensors.humidity.toFixed(1) + '%';
            }
            if (sensors.last_reading) {
                document.getElementById('last-update').textContent = formatFirebaseTime(sensors.last_reading);
            }
        }

        function checkForNewAlerts(alerts) {
            const alertKeys = Object.keys(alerts).sort().reverse();
            
            for (const alertKey of alertKeys) {
                const alert = alerts[alertKey];
                
                if (alert && !alert.taken && !alert.notified && !shownAlerts.has(alertKey)) {
                    showAlertPopup(alert, alertKey);
                    shownAlerts.add(alertKey);
                    break;
                }
            }
        }

        function showAlertPopup(alert, alertKey) {
            closeAlert();
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const popup = document.createElement('div');
            popup.className = 'alert-popup';
            popup.innerHTML = `
                <div class="alert-title">üö® MEDICINE ALERT!</div>
                <div class="alert-patient">üë§ Patient: ${alert.patient}</div>
                <div class="alert-medicine">üíä Medicine: ${alert.medicine}</div>
                <div class="alert-time">‚è∞ Scheduled: ${alert.scheduled_time}</div>
                <div class="alert-time">üì¶ Box: ${alert.box}</div>
                <button class="close-alert" onclick="closeAlert()">‚úÖ Dismiss Alert</button>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
            
            const alertRef = window.firebaseRef(window.firebaseDatabase, `alerts/${alertKey}/notified`);
            window.firebaseSet(alertRef, true);
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('üíä Medicine Alert!', {
                    body: `${alert.patient} needs to take ${alert.medicine} now! (Box ${alert.box})`,
                    requireInteraction: true
                });
            }
            
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance();
                speech.text = `Medicine alert! ${alert.patient}, it's time to take your medicine ${alert.medicine}`;
                window.speechSynthesis.speak(speech);
            }
            
            currentAlert = { popup, overlay };
        }

        function closeAlert() {
            if (currentAlert) {
                if (currentAlert.popup) currentAlert.popup.remove();
                if (currentAlert.overlay) currentAlert.overlay.remove();
                currentAlert = null;
            } else {
                const existingPopup = document.querySelector('.alert-popup');
                const existingOverlay = document.querySelector('.overlay');
                if (existingPopup) existingPopup.remove();
                if (existingOverlay) existingOverlay.remove();
            }
        }

        function loadScheduleForms() {
            const container = document.getElementById('schedule-forms');
            if (!container) return;
            
            container.innerHTML = '';

            for (let i = 1; i <= 3; i++) {
                const form = document.createElement('div');
                form.className = 'schedule-form';
                form.innerHTML = `
                    <h3>üì¶ Box ${i} Schedule</h3>
                    <div class="form-grid">
                        <div>
                            <label>üë§ Patient Name:</label>
                            <input type="text" id="patient-${i}" class="form-input" placeholder="Enter patient name">
                        </div>
                        <div>
                            <label>üíä Medicine Name:</label>
                            <input type="text" id="medicine-${i}" class="form-input" placeholder="Enter medicine name">
                        </div>
                    </div>
                    <div class="time-grid">
                        <div>
                            <label>üïê Hour (0-23):</label>
                            <input type="number" id="hour-${i}" class="form-input" min="0" max="23" value="12">
                        </div>
                        <div>
                            <label>üìã Minute (0-59):</label>
                            <input type="number" id="minute-${i}" class="form-input" min="0" max="59" value="0">
                        </div>
                        <div>
                            <label>‚è±Ô∏è Second (0-59):</label>
                            <input type="number" id="second-${i}" class="form-input" min="0" max="59" value="0">
                        </div>
                        <div>
                            <label>üîî Status:</label>
                            <select id="active-${i}" class="form-input">
                                <option value="true">‚úÖ Active</option>
                                <option value="false">‚ùå Inactive</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="saveSchedule(${i})" class="save-btn">üíæ Save Schedule</button>
                    <button onclick="clearSchedule(${i})" class="clear-btn">üóëÔ∏è Clear Schedule</button>
                    <div id="status-${i}" style="margin-top: 10px; font-weight: bold;"></div>
                `;
                container.appendChild(form);
                loadExistingSchedule(i);
            }
        }

        function loadExistingSchedule(boxNumber) {
            const scheduleRef = window.firebaseRef(window.firebaseDatabase, `schedule/box${boxNumber}`);
            window.firebaseGet(scheduleRef).then((snapshot) => {
                const schedule = snapshot.val();
                if (schedule) {
                    document.getElementById('patient-' + boxNumber).value = schedule.patient || '';
                    document.getElementById('medicine-' + boxNumber).value = schedule.medicine || '';
                    document.getElementById('hour-' + boxNumber).value = schedule.hour || '12';
                    document.getElementById('minute-' + boxNumber).value = schedule.minute || '0';
                    document.getElementById('second-' + boxNumber).value = schedule.second || '0';
                    document.getElementById('active-' + boxNumber).value = schedule.active !== false ? 'true' : 'false';
                }
            }).catch((error) => {
                console.error('Error loading schedule:', error);
            });
        }

        function saveSchedule(boxNumber) {
            const patient = document.getElementById('patient-' + boxNumber).value.trim();
            const medicine = document.getElementById('medicine-' + boxNumber).value.trim();
            const hour = parseInt(document.getElementById('hour-' + boxNumber).value);
            const minute = parseInt(document.getElementById('minute-' + boxNumber).value);
            const second = parseInt(document.getElementById('second-' + boxNumber).value);
            const active = document.getElementById('active-' + boxNumber).value === 'true';

            if (!patient || !medicine || isNaN(hour) || isNaN(minute) || isNaN(second)) {
                showStatus(boxNumber, '‚ùå Please fill all fields correctly', 'error');
                return;
            }

            if (hour < 0 || hour > 23 || minute < 0 || minute > 59 || second < 0 || second > 59) {
                showStatus(boxNumber, '‚ùå Please enter valid time values', 'error');
                return;
            }

            const scheduleData = { 
                patient, 
                medicine, 
                hour, 
                minute, 
                second, 
                active, 
                medicine_time: false, // Reset medicine_time flag
                last_updated: new Date().toISOString() 
            };
            
            const scheduleRef = window.firebaseRef(window.firebaseDatabase, `schedule/box${boxNumber}`);
            
            window.firebaseSet(scheduleRef, scheduleData)
                .then(() => showStatus(boxNumber, '‚úÖ Schedule saved successfully!', 'success'))
                .catch((error) => showStatus(boxNumber, '‚ùå Error: ' + error.message, 'error'));
        }

        function clearSchedule(boxNumber) {
            if (confirm('Are you sure you want to clear this schedule?')) {
                const scheduleRef = window.firebaseRef(window.firebaseDatabase, `schedule/box${boxNumber}`);
                window.firebaseRemove(scheduleRef)
                    .then(() => {
                        document.getElementById('patient-' + boxNumber).value = '';
                        document.getElementById('medicine-' + boxNumber).value = '';
                        document.getElementById('hour-' + boxNumber).value = '12';
                        document.getElementById('minute-' + boxNumber).value = '0';
                        document.getElementById('second-' + boxNumber).value = '0';
                        document.getElementById('active-' + boxNumber).value = 'true';
                        showStatus(boxNumber, '‚úÖ Schedule cleared!', 'success');
                    })
                    .catch((error) => showStatus(boxNumber, '‚ùå Error: ' + error.message, 'error'));
            }
        }

        function showStatus(boxNumber, message, type) {
            const statusDiv = document.getElementById('status-' + boxNumber);
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'green' : 'red';
            setTimeout(() => statusDiv.textContent = '', 5000);
        }

        function loadReports() {
            const container = document.getElementById('reports-container');
            container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading reports...</div>';

            const reportsRef = window.firebaseRef(window.firebaseDatabase, 'reports');
            window.firebaseGet(reportsRef).then((snapshot) => {
                const reports = snapshot.val() || {};
                displayReports(reports);
            }).catch((error) => {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Error loading reports</div>';
            });
        }

        function displayReports(reports) {
            const container = document.getElementById('reports-container');
            
            if (!reports || Object.keys(reports).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No Reports Yet</h3>
                        <p>Reports will appear here when medicines are taken or missed.</p>
                        <p>Set up schedules and the system will start tracking medication events.</p>
                    </div>
                `;
                return;
            }

            const reportsArray = Object.entries(reports).map(([key, value]) => ({ id: key, ...value }))
                .sort((a, b) => {
                    const timeA = a.taken_time || a.missed_time || a.alert_time || '';
                    const timeB = b.taken_time || b.missed_time || b.alert_time || '';
                    return new Date(timeB) - new Date(timeA);
                });

            // Calculate statistics
            const total = reportsArray.length;
            const taken = reportsArray.filter(r => r.taken).length;
            const missed = reportsArray.filter(r => !r.taken && r.status === 'missed').length;
            const onTime = reportsArray.filter(r => r.on_time).length;
            const complianceRate = total > 0 ? ((taken / total) * 100).toFixed(1) : 0;

            let html = `
                <div class="report-stats">
                    <div class="stat-card">
                        <div style="font-size: 2em; font-weight: bold; color: #3498db;">${total}</div>
                        <div>Total Events</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 2em; font-weight: bold; color: #27ae60;">${taken}</div>
                        <div>Medicines Taken</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 2em; font-weight: bold; color: #e74c3c;">${missed}</div>
                        <div>Medicines Missed</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 2em; font-weight: bold; color: #27ae60;">${complianceRate}%</div>
                        <div>Compliance Rate</div>
                    </div>
                </div>

                <h3>Recent Medicine History</h3>
                <div style="max-height: 500px; overflow-y: auto; margin-top: 20px;">
            `;
            
            reportsArray.forEach(report => {
                const time = report.taken_time || report.missed_time || report.alert_time;
                const status = report.taken ? 'Taken' : 'Missed';
                const statusClass = report.taken ? '' : 'missed';
                const icon = report.taken ? '‚úÖ' : '‚ùå';
                const timeType = report.taken_time ? 'Taken' : (report.missed_time ? 'Missed' : 'Alert');

                html += `
                    <div class="report-item ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>${report.patient}</strong> - ${report.medicine}
                                <br>
                                <small style="color: #666;">
                                    Scheduled: ${report.scheduled_time} | 
                                    ${timeType}: ${formatFirebaseTime(time)}
                                    ${report.on_time !== undefined ? ` | ${report.on_time ? 'Taken on time' : 'Taken late'}` : ''}
                                </small>
                            </div>
                            <div style="margin-left: 15px; font-weight: bold; color: ${report.taken ? '#27ae60' : '#e74c3c'};">
                                ${icon} ${status}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Manual trigger function for testing
        function manualTrigger(boxNumber) {
            const schedule = scheduleData['box' + boxNumber] || {};
            if (schedule.patient && schedule.medicine) {
                triggerMedicineTime(boxNumber, schedule);
            } else {
                alert('Please set patient and medicine name first for Box ' + boxNumber);
            }
        }
    </script>
</body>
</html>